name: Container Images
on:
  push:
    branches:
      - main
  pull_request:
  release:
    types: [published]

env:
  DEFAULT_PYTHON: "3.11"
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      attestations: write
      id-token: write

    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12", "3.13", "3.14"]

    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # Needed for setuptools-scm

      - name: Get version from setuptools-scm
        id: version
        run: |
          pip install setuptools-scm
          VERSION=$(python -m setuptools_scm)
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Check if default Python version
        id: is-default
        run: |
          if [ "${{ matrix.python-version }}" = "${{ env.DEFAULT_PYTHON }}" ]; then
            echo "value=true" >> $GITHUB_OUTPUT
          else
            echo "value=false" >> $GITHUB_OUTPUT
          fi

      - name: Log into GitHub Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags, labels) for slim image
        id: meta-slim
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          flavor: |
            latest=false
            suffix=-slim
          # NOTE: `latest=false` lets us manage it better here
          tags: |
            # For default Python version (unprefixed convenience tags)
            # - 'latest-slim' on push to main
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' && steps.is-default.outputs.value == 'true' }}
            # - 'stable-slim' on release
            type=raw,value=stable,enable=${{ github.event_name == 'release' && steps.is-default.outputs.value == 'true' }}
            # - version tag (e.g., v0.8.43-slim) on release
            type=ref,event=tag,enable=${{ steps.is-default.outputs.value == 'true' }}

            # For all Python versions (including default):
            # - 'python3.x-latest-slim' on push to main
            type=raw,value=python${{ matrix.python-version }}-latest,enable=${{ github.ref == 'refs/heads/main' }}
            # - 'python3.x-stable-slim' on release
            type=raw,value=python${{ matrix.python-version }}-stable,enable=${{ github.event_name == 'release' }}
            # - 'python3.x-v*-slim' on release
            type=ref,event=tag,prefix=python${{ matrix.python-version }}-,enable=${{ github.event_name == 'release' }}

            # PR tags for testing (not pushed)
            type=ref,event=pr,prefix=python${{ matrix.python-version }}-pr-
          labels: |
            org.opencontainers.image.title=ape
            org.opencontainers.image.description=Ape Framework: Build and explore on-chain with Python
            org.opencontainers.image.url=https://apeworx.io/framework
            org.opencontainers.image.documentation=https://docs.apeworx.io/ape/stable/userguides/quickstart
            org.opencontainers.image.source=https://github.com/ApeWorX/ape
            org.opencontainers.image.vendor=ApeWorX LTD
            org.opencontainers.image.licenses=Apache-2.0
            org.opencontainers.image.version=${{ steps.version.outputs.version }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.authors=ApeWorX LTD
            org.opencontainers.image.base.name=python:${{ matrix.python-version }}-slim

      - name: Build and push (if required) slim
        id: build-slim
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile.slim
          build-args: |
            PYTHON_VERSION=${{ matrix.python-version }}
            APE_VERSION=${{ steps.version.outputs.version }}
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta-slim.outputs.tags }}
          labels: ${{ steps.meta-slim.outputs.labels }}
          cache-from: type=gha,scope=slim-py${{ matrix.python-version }}
          cache-to: type=gha,mode=max,scope=slim-py${{ matrix.python-version }}
          platforms: linux/amd64,linux/arm64

      - name: Generate Docker metadata (full)
        id: meta-full
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          flavor: |
            latest=false
          # NOTE: `latest=false` lets us manage it better here
          tags: |
            # For default Python version (unprefixed convenience tags)
            # - 'latest' on push to main
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' && steps.is-default.outputs.value == 'true' }}
            # - 'stable' on release
            type=raw,value=stable,enable=${{ github.event_name == 'release' && steps.is-default.outputs.value == 'true' }}
            # - version tag (e.g., v0.8.43) on release
            type=ref,event=tag,enable=${{ steps.is-default.outputs.value == 'true' }}

            # For all Python versions (including default)
            # - 'python3.x-latest' on push to main
            type=raw,value=python${{ matrix.python-version }}-latest,enable=${{ github.ref == 'refs/heads/main' }}
            # - 'python3.x-stable' on release
            type=raw,value=python${{ matrix.python-version }}-stable,enable=${{ github.event_name == 'release' }}
            # - 'python3.x-v*' on release
            type=ref,event=tag,prefix=python${{ matrix.python-version }}-,enable=${{ github.event_name == 'release' }}

            # PR tags for testing (not pushed)
            type=ref,event=pr,prefix=python${{ matrix.python-version }}-pr-
          labels: |
            org.opencontainers.image.title=ape
            org.opencontainers.image.description=Ape Framework: Build and explore on-chain with Python (with recommended plugins)
            org.opencontainers.image.url=https://apeworx.io/framework
            org.opencontainers.image.documentation=https://docs.apeworx.io/ape/stable/userguides/quickstart
            org.opencontainers.image.source=https://github.com/ApeWorX/ape
            org.opencontainers.image.vendor=ApeWorX LTD
            org.opencontainers.image.licenses=Apache-2.0
            org.opencontainers.image.version=${{ steps.version.outputs.version }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.authors=ApeWorX LTD
            org.opencontainers.image.base.name=python:${{ matrix.python-version }}-slim

      - name: Build and push (if required) full image (with recommended plugins)
        id: build-full
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          build-args: |
            SLIM_IMAGE=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@${{ steps.build-slim.outputs.digest }}
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta-full.outputs.tags }}
          labels: ${{ steps.meta-full.outputs.labels }}
          cache-from: type=gha,scope=full-py${{ matrix.python-version }}
          cache-to: type=gha,mode=max,scope=full-py${{ matrix.python-version }}
          platforms: linux/amd64,linux/arm64

      - name: Summary
        run: |
          echo "## Docker Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Python Version:** ${{ matrix.python-version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Ape Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Slim Image Tags" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta-slim.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Full Image Tags" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta-full.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Run container retention policy
        # TODO: Use `v3` when available
        uses: snok/container-retention-policy@v3.0.1
        with:
          account: ApeWorX
          token: ${{ secrets.GITHUB_TOKEN }}
          image-names: "ape"
          # NOTE: Keep stable/stable-slim, latest/latest-slim, all v0.8.x series, and last in v0.7.x series
          image-tags: "!stable* !latest* !v0.8* !v0.7.23*"
          tag-selection: both
          cut-off: 4w
          dry-run: ${{ github.ref != 'refs/heads/main' }}
